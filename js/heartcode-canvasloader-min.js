/*
* Copyright (c) 2011 RÃ³bert Pataki
* 
* Permission is hereby granted, free of charge, to any person obtaining a copy
* of this software and associated documentation files (the "Software"), to deal
* in the Software without restriction, including without limitation the rights
* to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the Software is
* furnished to do so, subject to the following conditions:
* 
* The above copyright notice and this permission notice shall be included in
* all copies or substantial portions of the Software.
* 
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
* OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
* THE SOFTWARE.
* 
* ----------------------------------------------------------------------------------------
* 
* Check out my GitHub:	http://github.com/heartcode/
* Send me an email:		heartcode@robertpataki.com
* Follow me on Twitter:	http://twitter.com/#iHeartcode
* Blog:					http://heartcode.robertpataki.com
*//**
* CanvasLoader uses the HTML5 canvas element in modern browsers and VML in IE6/7/8 to create and animate the most popular preloader shapes (oval, spiral, rectangle, square and rounded rectangle).<br/><br/>
* It is important to note that CanvasLoader doesn't show up and starts rendering automatically on instantiation. To start rendering and display the loader use the <code>show()</code> method.
* @module CanvasLoader
**/(function(e){"use strict";var t=function(e,t){typeof t=="undefined"&&(t={}),this.init(e,t)},n=t.prototype,r,i=["canvas","vml"],s=["oval","spiral","square","rect","roundRect"],o=/^\#([a-fA-F0-9]{6}|[a-fA-F0-9]{3})$/,u=navigator.appVersion.indexOf("MSIE")!==-1&&parseFloat(navigator.appVersion.split("MSIE")[1])===8?!0:!1,a=!!document.createElement("canvas").getContext,f=40,l=!0,c=function(e,t,n){var r=document.createElement(e),i;for(i in n)r[i]=n[i];return typeof t!="undefined"&&t!==null&&t.appendChild(r),r},h=function(e,t){for(var n in t)e.style[n]=t[n];return e},p=function(e,t){for(var n in t)e.setAttribute(n,t[n]);return e},d=function(e,t,n,r){e.save(),e.translate(t,n),e.rotate(r),e.translate(-t,-n),e.beginPath()};n.init=function(e,n){typeof n.safeVML=="boolean"&&(l=n.safeVML);try{document.getElementById(e)!==undefined?this.mum=document.getElementById(e):this.mum=document.body}catch(s){this.mum=document.body}n.id=typeof n.id!="undefined"?n.id:"canvasLoader",this.cont=c("div",this.mum,{id:n.id});if(a)r=i[0],this.can=c("canvas",this.cont),this.con=this.can.getContext("2d"),this.cCan=h(c("canvas",this.cont),{display:"none"}),this.cCon=this.cCan.getContext("2d");else{r=i[1];if(typeof t.vmlSheet=="undefined"){document.getElementsByTagName("head")[0].appendChild(c("style")),t.vmlSheet=document.styleSheets[document.styleSheets.length-1];var o=["group","oval","roundrect","fill"],u;for(u in o)t.vmlSheet.addRule(o[u],"behavior:url(#default#VML); position:absolute;")}this.vml=c("group",this.cont)}this.setColor(this.color),this.draw(),h(this.cont,{display:"none"})},n.cont={},n.can={},n.con={},n.cCan={},n.cCon={},n.timer={},n.activeId=0,n.diameter=40,n.setDiameter=function(e){this.diameter=Math.round(Math.abs(e)),this.redraw()},n.getDiameter=function(){return this.diameter},n.cRGB={},n.color="#000000",n.setColor=function(e){this.color=o.test(e)?e:"#000000",this.cRGB=this.getRGB(this.color),this.redraw()},n.getColor=function(){return this.color},n.shape=s[0],n.setShape=function(e){var t;for(t in s)if(e===s[t]){this.shape=e,this.redraw();break}},n.getShape=function(){return this.shape},n.density=40,n.setDensity=function(e){l&&r===i[1]?this.density=Math.round(Math.abs(e))<=f?Math.round(Math.abs(e)):f:this.density=Math.round(Math.abs(e)),this.density>360&&(this.density=360),this.activeId=0,this.redraw()},n.getDensity=function(){return this.density},n.range=1.3,n.setRange=function(e){this.range=Math.abs(e),this.redraw()},n.getRange=function(){return this.range},n.speed=2,n.setSpeed=function(e){this.speed=Math.round(Math.abs(e))},n.getSpeed=function(){return this.speed},n.fps=24,n.setFPS=function(e){this.fps=Math.round(Math.abs(e)),this.reset()},n.getFPS=function(){return this.fps},n.getRGB=function(e){return e=e.charAt(0)==="#"?e.substring(1,7):e,{r:parseInt(e.substring(0,2),16),g:parseInt(e.substring(2,4),16),b:parseInt(e.substring(4,6),16)}},n.draw=function(){var e=0,t,n,o,a,f,l,v,m,g=this.density,y=Math.round(g*this.range),b,w=0,E,S,x,T,N=1e3,C=0,k=this.cCon,L=this.diameter,A=.47;if(r===i[0]){k.clearRect(0,0,N,N),p(this.can,{width:L,height:L}),p(this.cCan,{width:L,height:L});while(e<g){b=e<=y?1-(1-w)/y*e:b=w,l=270-360/g*e,v=l/180*Math.PI,k.fillStyle="rgba("+this.cRGB.r+","+this.cRGB.g+","+this.cRGB.b+","+b.toString()+")";switch(this.shape){case s[0]:case s[1]:t=L*.07,a=L*A+Math.cos(v)*(L*A-t)-L*A,f=L*A+Math.sin(v)*(L*A-t)-L*A,k.beginPath(),this.shape===s[1]?k.arc(L*.5+a,L*.5+f,t*b,0,Math.PI*2,!1):k.arc(L*.5+a,L*.5+f,t,0,Math.PI*2,!1);break;case s[2]:t=L*.12,a=Math.cos(v)*(L*A-t)+L*.5,f=Math.sin(v)*(L*A-t)+L*.5,d(k,a,f,v),k.fillRect(a,f-t*.5,t,t);break;case s[3]:case s[4]:n=L*.3,o=n*.27,a=Math.cos(v)*(o+(L-o)*.13)+L*.5,f=Math.sin(v)*(o+(L-o)*.13)+L*.5,d(k,a,f,v),this.shape===s[3]?k.fillRect(a,f-o*.5,n,o):(m=o*.55,k.moveTo(a+m,f-o*.5),k.lineTo(a+n-m,f-o*.5),k.quadraticCurveTo(a+n,f-o*.5,a+n,f-o*.5+m),k.lineTo(a+n,f-o*.5+o-m),k.quadraticCurveTo(a+n,f-o*.5+o,a+n-m,f-o*.5+o),k.lineTo(a+m,f-o*.5+o),k.quadraticCurveTo(a,f-o*.5+o,a,f-o*.5+o-m),k.lineTo(a,f-o*.5+m),k.quadraticCurveTo(a,f-o*.5,a+m,f-o*.5))}k.closePath(),k.fill(),k.restore(),++e}}else{h(this.cont,{width:L,height:L}),h(this.vml,{width:L,height:L});switch(this.shape){case s[0]:case s[1]:x="oval",t=N*.14;break;case s[2]:x="roundrect",t=N*.12;break;case s[3]:case s[4]:x="roundrect",t=N*.3}n=o=t,a=N*.5-o,f=-o*.5;while(e<g){b=e<=y?1-(1-w)/y*e:b=w,l=270-360/g*e;switch(this.shape){case s[1]:n=o=t*b,a=N*.5-t*.5-t*b*.5,f=(t-t*b)*.5;break;case s[0]:case s[2]:u&&(f=0,this.shape===s[2]&&(a=N*.5-o*.5));break;case s[3]:case s[4]:n=t*.95,o=n*.28,u?(a=0,f=N*.5-o*.5):(a=N*.5-n,f=-o*.5),C=this.shape===s[4]?.6:0}S=p(h(c("group",this.vml),{width:N,height:N,rotation:l}),{coordsize:N+","+N,coordorigin:-N*.5+","+ -N*.5}),E=h(c(x,S,{stroked:!1,arcSize:C}),{width:n,height:o,top:f,left:a}),T=c("fill",E,{color:this.color,opacity:b}),++e}}this.tick(!0)},n.clean=function(){if(r===i[0])this.con.clearRect(0,0,1e3,1e3);else{var e=this.vml;if(e.hasChildNodes())while(e.childNodes.length>=1)e.removeChild(e.firstChild)}},n.redraw=function(){this.clean(),this.draw()},n.reset=function(){typeof this.timer=="number"&&(this.hide(),this.show())},n.tick=function(e){var t=this.con,n=this.diameter;e||(this.activeId+=360/this.density*this.speed),r===i[0]?(t.clearRect(0,0,n,n),d(t,n*.5,n*.5,this.activeId/180*Math.PI),t.drawImage(this.cCan,0,0,n,n),t.restore()):(this.activeId>=360&&(this.activeId-=360),h(this.vml,{rotation:this.activeId}))},n.show=function(){if(typeof this.timer!="number"){var e=this;this.timer=self.setInterval(function(){e.tick()},Math.round(1e3/this.fps)),h(this.cont,{display:"block"})}},n.hide=function(){typeof this.timer=="number"&&(clearInterval(this.timer),delete this.timer,h(this.cont,{display:"none"}))},n.kill=function(){var e=this.cont;typeof this.timer=="number"&&this.hide(),r===i[0]?(e.removeChild(this.can),e.removeChild(this.cCan)):e.removeChild(this.vml);var t;for(t in this)delete this[t]},e.CanvasLoader=t})(window);